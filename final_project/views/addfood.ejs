<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Foodaily</title>

    <!-- Bootstrap Core CSS -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="/css/plugins/metisMenu/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/css/sb-admin-2.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/font-awesome-4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css">
    <link rel="stylesheet" href="/magnificPopup/magnific-popup.css">
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/jquery-ui.min.css">
    <link rel="stylesheet" type="text/css" href="/stylesheets/jquery-ui.theme.min.css">
    <link rel="stylesheet" type="text/css" href="/chosen_v1.2.0/chosen.min.css">
    <script src="/chosen_v1.2.0/chosen.jquery.js"></script>
    <script src="/chosen_v1.2.0/chosen.proto.js"></script>
    <script src="/magnificPopup/jquery.magnific-popup.js"></script> 
    <script src="https://www.google.com/jsapi"></script>
    <script src="http://underscorejs.org/underscore.js"></script>
    <script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
    <script src="/stylesheets/jquery.datetimepicker.js"></script>
    <link rel="stylesheet" type="text/css" href="/stylesheets/jquery.datetimepicker.css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div id="wrapper">

        <!-- Navigation -->
        <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="index.html">Foodaily</a>
            </div>
            <!-- /.navbar-header -->

            <!-- 
            <ul class="nav navbar-top-links navbar-right">
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-envelope fa-fw"></i>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-messages">
                        <li>
                            <a href="#">
                                <div>
                                    <strong>John Smith</strong>
                                    <span class="pull-right text-muted">
                                        <em>Yesterday</em>
                                    </span>
                                </div>
                                <div>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque eleifend...</div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <strong>John Smith</strong>
                                    <span class="pull-right text-muted">
                                        <em>Yesterday</em>
                                    </span>
                                </div>
                                <div>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque eleifend...</div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <strong>John Smith</strong>
                                    <span class="pull-right text-muted">
                                        <em>Yesterday</em>
                                    </span>
                                </div>
                                <div>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Pellentesque eleifend...</div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a class="text-center" href="#">
                                <strong>Read All Messages</strong>
                                <i class="fa fa-angle-right"></i>
                            </a>
                        </li>
                    </ul>
                    <!-- /.dropdown-messages -->
                <!-- </li> -->
                <!-- /.dropdown -->
                <!-- 
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-tasks fa-fw"></i>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-tasks">
                        <li>
                            <a href="#">
                                <div>
                                    <p>
                                        <strong>Task 1</strong>
                                        <span class="pull-right text-muted">40% Complete</span>
                                    </p>
                                    <div class="progress progress-striped active">
                                        <div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
                                            <span class="sr-only">40% Complete (success)</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <p>
                                        <strong>Task 2</strong>
                                        <span class="pull-right text-muted">20% Complete</span>
                                    </p>
                                    <div class="progress progress-striped active">
                                        <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100" style="width: 20%">
                                            <span class="sr-only">20% Complete</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <p>
                                        <strong>Task 3</strong>
                                        <span class="pull-right text-muted">60% Complete</span>
                                    </p>
                                    <div class="progress progress-striped active">
                                        <div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: 60%">
                                            <span class="sr-only">60% Complete (warning)</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <p>
                                        <strong>Task 4</strong>
                                        <span class="pull-right text-muted">80% Complete</span>
                                    </p>
                                    <div class="progress progress-striped active">
                                        <div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100" style="width: 80%">
                                            <span class="sr-only">80% Complete (danger)</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a class="text-center" href="#">
                                <strong>See All Tasks</strong>
                                <i class="fa fa-angle-right"></i>
                            </a>
                        </li>
                    </ul> -->
                    <!-- /.dropdown-tasks -->
              <!--   </li> -->
                <!-- /.dropdown -->
                <!-- 
                <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-bell fa-fw"></i>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-alerts">
                        <li>
                            <a href="#">
                                <div>
                                    <i class="fa fa-comment fa-fw"></i> New Comment
                                    <span class="pull-right text-muted small">4 minutes ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <i class="fa fa-twitter fa-fw"></i> 3 New Followers
                                    <span class="pull-right text-muted small">12 minutes ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <i class="fa fa-envelope fa-fw"></i> Message Sent
                                    <span class="pull-right text-muted small">4 minutes ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <i class="fa fa-tasks fa-fw"></i> New Task
                                    <span class="pull-right text-muted small">4 minutes ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="#">
                                <div>
                                    <i class="fa fa-upload fa-fw"></i> Server Rebooted
                                    <span class="pull-right text-muted small">4 minutes ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a class="text-center" href="#">
                                <strong>See All Alerts</strong>
                                <i class="fa fa-angle-right"></i>
                            </a>
                        </li>
                    </ul> -->
                    <!-- /.dropdown-alerts -->
                <!-- </li> -->
                <!-- /.dropdown -->
                <!-- <li class="dropdown">
                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                        <i class="fa fa-user fa-fw"></i>  <i class="fa fa-caret-down"></i>
                    </a>
                    <ul class="dropdown-menu dropdown-user">
                        <li><a href="#"><i class="fa fa-user fa-fw"></i> User Profile</a>
                        </li>
                        <li><a href="#"><i class="fa fa-gear fa-fw"></i> Settings</a>
                        </li>
                        <li class="divider"></li>
                        <li><a href="login.html"><i class="fa fa-sign-out fa-fw"></i> Logout</a>
                        </li>
                    </ul> -->
                    <!-- /.dropdown-user -->
                <!-- </li> -->
                <!-- /.dropdown -->
           <!--  </ul> -->
            <!-- /.navbar-top-links -->

            <div class="navbar-default sidebar" role="navigation">
                <div class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                        <li class="sidebar-search">
                            <div class="input-group custom-search-form">
                                <input type="text" class="form-control" placeholder="Search...">
                                <span class="input-group-btn">
                                    <button class="btn btn-default" type="button">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </span>
                            </div>
                            <!-- /input-group -->
                        </li>
                        <li>
                            <a href="/<%= user.slug %>/dashboard"><i class="fa fa-dashboard fa-fw"></i> Dashboard</a>
                        </li>
                        <li>
                            <a href="/<%= user.slug %>/addfood"><i class="fa fa-table fa-fw"></i> Add Food</a>
                        </li>
                        <li>
                            <a href="/<%= user.slug %>/progress"><i class="fa fa-bar-chart-o fa-fw"></i> Your Progress</a>
                        </li>
                        <li>
                            <a href="#"><i class="fa fa-edit fa-fw"></i> Recipes<span class="fa arrow"></span></a>
                            <ul class="nav nav-second-level">
                                <li>
                                    <a href="/<%= user.slug %>/recipesearch">Search</a>
                                </li>
                                <li>
                                    <a href="/<%= user.slug %>/favorites">Favorites</a>
                                </li>
                            </ul>
                            <!-- /.nav-second-level -->
                        </li>
                        <li>
                            <a href="/<%= user.slug %>/settings"><i class="fa fa-wrench fa-fw"></i> Settings<span class="fa arrow"></span></a>
                        </li>
                    </ul>
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
        </nav>

        <!-- Page Content -->
        <div id="page-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <h1 class="page-header">Add Food</h1>
                    </div>
                    <!-- /.col-lg-12 -->

                    <!-- ============================================= -->
                    <!-- ======= MAIN PAGE CONTENT BEGINS HERE ======= -->
                    <!-- ============================================= -->
                    <div>
                        <!-- link that opens popup -->


<!-- form itself -->
<form id="foodForm" class="white-popup mfp-hide pure-form">
    <h1 id="foodName"></h1>
    <label for="spinner">Choose an amount</label>
    <input id="spinner" name="value">
    <button form="foodForm" class="pure-button">Save!</button>
    <div class="pieChart"></div>
    <p>Other nutritional info</p>
    <div class="formTable"></div>
    <input type="hidden" id="chosenFood" name="chosenFood" value="">
    <input type="hidden" id="csrf" name="_csrf" value="<%= csrfToken %>">
    <input type="hidden" id="slug" value="<%= user.slug %>">
</form>

 
<p>Search for a common food here!</p>
<form id="foodSearch">
    <span><input type="text" placeholder="Search..."></span>
</form>
<p id="notification" class="ui-widget-content ui-corner-all bomay"></p>

<!-- <p class="bomay">clgt</p> -->

<div class="foodChart"></div>
</br>

<!-- custom scripts go down here -->
<script src="/javascript/GoogleTable.js"></script>
<script src="/javascript/GooglePie.js"></script>
<script src="/javascript/config.js"></script>
<script src="/javascript/magnificPopup.js"></script>
<script src="/javascript/formTableConfig.js"></script>
<script>
    $('#datetimepicker').datetimepicker({
        format: 'Y/m/d H:i', 
        onSelectDate: function(ct, i) {
            console.log(ct)
            console.log(ct.dateFormat('d/m/Y'))
        },
        maxDate: 0
    })

    var spinner = $( "#spinner" ).spinner();
    var myPieChart = new GooglePie('.pieChart')
    // don't draw anything to begin with
    var initRows = []

    var handlers = {
        select: tableHandler,
        sort: loadMagnificPopup,
        page: loadMagnificPopup
    }
    var myTable = new GoogleTable('.foodChart', initRows, handlers, mainTableOptions)
    var myFormTable = new GoogleTable('.formTable', initRows, function(){}, formTableOptions)
    var rowData = []
    var rowJson = {}

    function tableHandler(e) {
        // data dump returns the array of the selected row
        var idx = myTable.googleTable.getSelection()
        if (!_.isEmpty(idx)) {
            myTable.selRow = idx[0]['row']
        }
        updateTable()
        updateForm()
    };

    function updateTable() {
        rowData = myTable.dataDump()
        rowJson = _.object(fields, rowData)
    }

    var txt = $('#foodName')
    var chosenId = $('#chosenFood')

    function updateForm() {
        // update the h2 text in the form
        txt.text(rowJson['item_name'])

        // for POST data later
        chosenId.val(rowJson['item_id'])

        var rows = []
        _.each(nutrition, function(value, key){
            rows.push([value, rowJson[key]])
        })

        myPieChart.draw(rows, {
            id3D: true,
            title: "Calories by macros",
            legend: {
                position: 'labeled',
                alignment: 'center'
            }
        })

        myFormTable.draw([rowData], {showRowNumber: false})
    }

    var $foodIn = $('#foodSearch')
    var $foodForm = $('#foodForm')

    // event listener for search box
    $foodIn.keypress(function(e){
        if(e.keyCode == 13) {
            // disable form submission
            e.preventDefault()

            // requests nutritionix, parse json and update google table
            queryDict["query"] = $('#foodSearch input').val();

            $.ajax({
                type: "POST",
                url: "https://api.nutritionix.com/v1_1/search",
                data: queryDict,
                success: function(d) {
                    d = _.pluck(d['hits'], 'fields')
                    d = _.map(d, function(val, index){
                        return _.values(val)
                    })
                    myTable.draw(d)

                    // stick the magnific popup class to all rows
                    loadMagnificPopup()
                },
            });
        }
    })

    function loadMagnificPopup(){
        $('.google-visualization-table-table tr:not(.google-visualization-table-tr-head) td')
            .attr({
            class: 'popup-with-form',
            href: '#foodForm'
        })

        var last = 0
        $('.popup-with-form').magnificPopup({
                type: 'inline',
                preloader: true, 
                focus: '#name',
                removalDelay: 300,
                gallery: {
                    enabled: true
                },
                items: [
                {
                    src: '#foodForm',
                    type: 'inline'
                },
                {
                    src: '#foodForm',
                    type: 'inline'
                },
                {
                    src: '#foodForm',
                    type: 'inline'
                }],
                  mainClass: 'mfp-fade',
                  callbacks: {
                    change: function() {
                        var curr = this.index
                        var inc = true

                        if (curr == last) {
                            return
                        }

                        if (curr < last) {
                            inc = false
                        }

                        // wrao arounds
                        if (curr == 0 && last == 2) {
                            inc = true
                        } else if (curr == 2 && last == 0) {
                            inc = false
                        }

                        if (inc) {
                            myTable.inc()
                        } else {
                            myTable.dec()
                        }
                        updateTable()
                        updateForm()

                        last = curr
                    }
                }  
        });
    }

    // popup form
    var userSlug = $('#slug').val()
    var csrf = $('#csrf').val()
    var magnificPopup = $.magnificPopup
    var notification = $('#notification')

    notification.hide()

    $foodForm.on('submit', function(e){
        e.preventDefault()
        $.ajax({
            type: 'POST',
            url: '/'+userSlug+'/foods',
            data: {
              _csrf: csrf,
              amount: spinner.spinner('value'),
              chosenFood: $('#chosenFood').val()
            },
            success: function(d) {

                console.log(d)
                notification.text(d)
                notification.show("fold", {}, 1000, function(){
                    setTimeout(function() {
                        notification.fadeOut();
                    }, 1000 );
                })              

              magnificPopup.close()
            },
            error: function(xhr, textStatus) {
                notification.text(textStatus)
                notification.show("fold", {}, 1000, function(){
                    setTimeout(function() {
                        notification.fadeOut();
                    }, 1000 );
                })          

              magnificPopup.close()
            }
        })
    })

    $('.popup-with-form').on('mfpOpen', function(e /*, params */) {
      console.log('Popup opened',  $.magnificPopup.instance);
    });
</script>




                

                    </div>
                <!-- /.row -->
            </div>
            <!-- /.container-fluid -->
        </div>
        <!-- /#page-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <!--<script src="../js/jquery.js"></script> -->

    <!-- Bootstrap Core JavaScript -->
    <script src="../js/bootstrap.min.js"></script>

    <!-- Metis Menu Plugin JavaScript -->
    <script src="../js/plugins/metisMenu/metisMenu.min.js"></script>

    <!-- Custom Theme JavaScript -->
    <script src="../js/sb-admin-2.js"></script>

</body>

</html>
